{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}MyChat{% endblock %}</title>

  <!-- Bootstrap + Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'css/chat_base.css' %}">
  <style>
    .status-dot {
      height: 10px;
      width: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }
    .online { background-color: #28a745; }
    .offline { background-color: #6c757d; }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg" style="background: linear-gradient(90deg,#56d8e4,#a0e9ff);">
  <div class="container-fluid">
    <a class="navbar-brand text-dark fw-bold" href="{% url 'home' %}">MyChat</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
      <span class="navbar-toggler-icon"><i class="fa fa-bars"></i></span>
    </button>
    <div class="d-flex gap-3">
      <a class="nav-link text-dark" href="{% url 'profile' %}"><i class="fa fa-user me-1"></i>{{ user.username }}</a>
      <a class="nav-link text-dark" href="{% url 'logout' %}"><i class="fa fa-sign-out-alt me-1"></i>Logout</a>
    </div>
  </div>
</nav>

<!-- MAIN CONTENT -->
<div class="container-fluid p-0 chat-container">
  <div class="row g-0" style="height:100%;">

    <!-- SIDEBAR -->
    <div class="col-md-4 col-lg-3 sidebar border-end p-3">
      {% block sidebar %}

      <!-- GROUPS SECTION -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">My Groups</h6>
        <div class="flex-grow-4 mx-3">
          <input type="text" id="groupSearch" class="form-control form-control-sm" placeholder="Search groups...">
        </div>
        <a href="{% url 'new_group' %}" class="btn btn-sm btn-success">+ Group</a>
      </div>

      <div id="groupsList">
        <ul class="list-group mb-4">
          {% for room in rooms %}
            {% if room.room_type == 'group' %}
              <li class="list-group-item">
                <a href="{% url 'group_chat' room.id %}" class="text-decoration-none d-block">
                  <strong>{{ room.name }}</strong>
                  <div class="small text-muted">Members: {{ room.participants.count }}</div>
                </a>
              </li>
            {% endif %}
          {% empty %}
            <li class="list-group-item text-center text-muted">No groups yet</li>
          {% endfor %}
        </ul>
      </div>

      <!-- CHATS SECTION -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">My Chats</h6>
        <div class="flex-grow-4 mx-3">
          <input type="text" id="chatSearch" class="form-control form-control-sm" placeholder="Search chats...">
        </div>
        <button id="generatePrivateInvite" class="btn btn-sm btn-success">+ Invite</button>
      </div>

      <!-- Private Invite Modal -->
      <div class="modal fade" id="privateInviteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-success text-white">
              <h5 class="modal-title">Invite Someone (Private Chat)</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
              <p>Click below to generate a private chat invite link:</p>
              <button id="generatePrivateInviteBtn" class="btn btn-success">Generate Invite Link</button>
              <div id="privateInviteResult" class="mt-3" style="display:none;">
                <input type="text" id="privateInviteLink" class="form-control mb-2" readonly>
                <small class="text-muted">Invite Code: <span id="privateInviteCode"></span></small><br>
                <button id="copyPrivateInviteButton" class="btn btn-primary mt-2" onclick="copyPrivateInviteLink()">Copy Link</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="chatsList">
        <ul class="list-group">
          {% for u in users %}
            {% if u != request.user %}
              <li class="list-group-item">
                <a href="{% url 'start_chat' u.username %}" class="text-decoration-none d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <span class="status-dot {% if u.is_online %}online{% else %}offline{% endif %}" data-user-id="{{ u.id }}"></span>
                    <span class="ms-2 text-dark fw-semibold">{{ u.username }}</span>
                  </div>
                  <div class="small text-muted">Chat</div>
                </a>
              </li>
            {% endif %}
          {% empty %}
            <li class="list-group-item text-center text-muted">No other users</li>
          {% endfor %}
        </ul>
      </div>

      {% endblock %}

      <ul class="list-group mt-3">
        <li class="list-group-item">
          <a href="{% url 'ai_chat' %}" class="text-decoration-none d-block">
            <i class="fa fa-robot me-2 text-primary"></i> Steve_AI
          </a>
        </li>
      </ul>
    </div>

    <!-- MAIN CHAT AREA -->
    <div class="col-md-8 col-lg-9 chat-window">
      {% block content %}
      <div class="d-flex flex-column justify-content-center align-items-center h-100 text-muted">
        <i class="fa fa-comments" style="font-size: 48px;"></i>
        <p class="mt-3">Select a group or chat to start messaging</p>
      </div>
      {% endblock %}
    </div>

  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Scroll chat box to bottom
  (function() {
    const box = document.getElementById('messagesBox');
    if (box) box.scrollTop = box.scrollHeight;
  })();

  // WebSocket for online/offline status
  const onlineSocket = new WebSocket('ws://' + window.location.host + '/ws/online_status/');
  onlineSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const dot = document.querySelector(`[data-user-id="${data.user_id}"]`);
    if (dot) {
      dot.classList.toggle("online", data.is_online);
      dot.classList.toggle("offline", !data.is_online);
    }
  };

  // Private Invite Modal
  document.getElementById('generatePrivateInvite').addEventListener('click', function() {
    const modal = new bootstrap.Modal(document.getElementById('privateInviteModal'));
    modal.show();
  });

  document.getElementById("generatePrivateInviteBtn").addEventListener("click", function() {
    fetch("{% url 'ajax_generate_private_invite' %}")
      .then(response => response.json())
      .then(data => {
        if (!data.error) {
          document.getElementById("privateInviteLink").value = data.invite_link;
          document.getElementById("privateInviteCode").textContent = data.invite_code;
          document.getElementById("privateInviteResult").style.display = 'block';
        } else alert(data.error);
      });
  });

  function copyPrivateInviteLink() {
    const input = document.getElementById('privateInviteLink');
    input.select();
    navigator.clipboard.writeText(input.value);
    const btn = document.getElementById('copyPrivateInviteButton');
    btn.textContent = "Copied!";
    btn.classList.replace('btn-primary', 'btn-success');
    setTimeout(() => {
      btn.textContent = "Copy Link";
      btn.classList.replace('btn-success', 'btn-primary');
    }, 2000);
  }

  // ðŸ” Live Search (Groups + Chats)
  // ðŸ” Live Search (Groups + Chats)
document.addEventListener("DOMContentLoaded", () => {
  const groupInput = document.getElementById("groupSearch");
  const chatInput = document.getElementById("chatSearch");
  const groupsList = document.getElementById("groupsList");
  const chatsList = document.getElementById("chatsList");

  function debounce(fn, delay) {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn(...args), delay);
    };
  }

  // ðŸ”¹ Search Groups
  const searchGroups = debounce((query) => {
    fetch(`/search/groups/?q=${encodeURIComponent(query)}`)
      .then(res => res.json())
      .then(data => {
        let html = "";
        if (data.groups.length === 0) {
          html = "<li class='list-group-item text-center text-muted'>No groups found</li>";
        } else {
          data.groups.forEach(g => {
            html += `
              <li class="list-group-item">
                <a href="/room/${g.id}/" class="text-decoration-none d-block">
                  <strong>${g.name}</strong>
                  <div class="small text-muted">Members: ${g.members}</div>
                </a>
              </li>`;
          });
        }
        groupsList.innerHTML = `<ul class="list-group mb-4">${html}</ul>`;
      });
  }, 300);

  // ðŸ”¹ Search Private Chats
  const searchChats = debounce((query) => {
    fetch(`/search/chats/?q=${encodeURIComponent(query)}`)
      .then(res => res.json())
      .then(data => {
        let html = "";
        if (data.chats.length === 0) {
          html = "<li class='list-group-item text-center text-muted'>No chats found</li>";
        } else {
          data.chats.forEach(c => {
            html += `
              <li class="list-group-item">
                <a href="/start_chat/${c.username}/" class="text-decoration-none d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <span class="status-dot offline"></span>
                    <span class="ms-2 text-dark fw-semibold">${c.username}</span>
                  </div>
                  <div class="small text-muted">Chat</div>
                </a>
              </li>`;
          });
        }
        chatsList.innerHTML = `<ul class="list-group">${html}</ul>`;
      });
  }, 300);

  groupInput.addEventListener("input", e => searchGroups(e.target.value));
  chatInput.addEventListener("input", e => searchChats(e.target.value));
});

</script>

</body>
</html>
