{% extends 'base/chat_base.html' %}
{% block content %}
<div class="container mt-3">
  <div class="card shadow-sm">

    <!-- Header / Chat Title -->
    <div class="card-header bg-primary text-white">
      <div class="d-flex align-items-center">
        {% if room.room_type == 'private' %}
          {% for participant in room.participants.all %}
            {% if participant != request.user %}
              <h5 class="mb-0"><i class="fa fa-user-circle me-2"></i>{{ participant.username }}</h5>
            {% endif %}
          {% endfor %}
        {% else %}
          <h5 class="mb-0">
              <a href="{% url 'group_info' room.id %}" class="text-white text-decoration-none">
               <i class="fa fa-users me-2"></i>{{ room.name|title }}
              </a>
          </h5>
        {% endif %}
      </div>
    </div>

    <!-- Chat Messages -->
    <div id="chat-messages" class="border rounded p-3 mb-3" 
         style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
      {% for message in messages %}
        <div class="mb-2 {% if message.sender == request.user %}text-end{% endif %}">
          <span class="badge {% if message.sender == request.user %}bg-light text-dark{% else %}bg-secondary{% endif %}">
            {{ message.sender.username }}
          </span><br>
          <span class="badge {% if message.sender == request.user %}bg-info text-white{% else %}bg-light{% endif %}">
            {{ message.content }}
          </span><br>
          <small class="text-muted">{{ message.timestamp|date:"H:i" }}</small>
        </div>
      {% empty %}
        <p class="text-center text-muted">No messages yet. Say hello 👋</p>
      {% endfor %}
    </div>

    <!-- Message Input -->
    <form id="chat-form" method="POST" action="{% url 'group_message' room.id %}" class="d-flex">
      {% csrf_token %}
      <input type="text" name="message" id="chat-message-input" 
             class="form-control me-2" placeholder="Type your message..." autocomplete="off">
      <button type="submit" class="btn btn-primary">Send</button>
    </form>
  </div>
</div>

<!-- WebSocket for user presence -->
<script>
  // Connect to online status WebSocket
  const presenceSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/online_status/'
  );

  presenceSocket.onopen = () => console.log("✅ Presence WebSocket connected");
  presenceSocket.onclose = () => console.log("❌ Presence WebSocket disconnected");

  presenceSocket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    const userId = data.user_id;
    const isOnline = data.is_online;

    // Match user’s status dot in sidebar
    const dot = document.querySelector(`[data-user-id="${userId}"]`);
    if (dot) {
      dot.classList.remove('online', 'offline');
      dot.classList.add(isOnline ? 'online' : 'offline');
    }
  };
</script>
{% endblock %}
